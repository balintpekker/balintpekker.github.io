{"componentChunkName":"component---src-templates-blog-post-js","path":"/attributes-in-drupal/","result":{"data":{"site":{"siteMetadata":{"title":"bPekker.dev"}},"markdownRemark":{"id":"044e3da1-285c-5c99-9689-617c7b7225c8","excerpt":"Drupal 10.2 is out, with an easier content management by improving user experience, and with some performance improvements in caching and HTTP responses. It is…","html":"<p><a href=\"https://www.drupal.org/project/drupal/releases/10.2.0\">Drupal 10.2</a> is out, with an easier content management by improving user experience, and with some performance improvements in caching and HTTP responses. It is also compatible with PHP 8.3, and it started using PHP attributes.</p>\n<blockquote>\n<p><a href=\"#how-does-the-code-change\">TL;DR; - Jump to the 'How to' section</a></p>\n</blockquote>\n<h3 id=\"what-are-attributes-in-php\" style=\"position:relative;\"><a href=\"#what-are-attributes-in-php\" aria-label=\"what are attributes in php permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What are attributes in PHP?</h3>\n<p>They introduce a flexible and standardized approach to add metadata to your code — similar to annotations —, enhancing readability and documentation. Annotations are declared using the <code class=\"language-text\">#[...]</code> syntax, positioned above the element to which you want to attach them. These can also take arguments, allowing you to convey specific information. For instance:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token attribute\"><span class=\"token delimiter punctuation\">#[</span><span class=\"token attribute-content\"><span class=\"token attribute-class-name class-name\">ExampleAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'argument'</span><span class=\"token punctuation\">)</span></span><span class=\"token delimiter punctuation\">]</span></span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">ExampleClass</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Class code here.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>To retrieve information about a class which is using attributes, the <a href=\"https://www.php.net/manual/en/book.reflection.php\">Reflection API</a> comes to the rescue. Using its <code class=\"language-text\">getAttributes()</code> method, you'll find yourself with an array of <a href=\"https://www.php.net/manual/en/class.reflectionattribute.php\">ReflectionAttribute</a> objects:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token variable\">$class</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ReflectionClass</span><span class=\"token punctuation\">(</span><span class=\"token class-name static-context\">ExampleClass</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$attributes</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$class</span><span class=\"token operator\">-></span><span class=\"token function\">getAttributes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/** @var \\ReflectionAttribute $attribute */</span>\n<span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$attributes</span> <span class=\"token keyword\">as</span> <span class=\"token variable\">$attribute</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$name</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$attribute</span><span class=\"token operator\">-></span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 'ExampleAttribute'</span>\n    <span class=\"token variable\">$arguments</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$attribute</span><span class=\"token operator\">-></span><span class=\"token function\">getArguments</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ['argument'] </span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Drupal uses a new class to parse attributes (e.g. from a Block plugin) based on this API, which we will talk about later.</p>\n<h5 id=\"handling-sensitive-data-use-case\" style=\"position:relative;\"><a href=\"#handling-sensitive-data-use-case\" aria-label=\"handling sensitive data use case permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Handling Sensitive Data (Use Case)</h5>\n<p>In PHP 8.2 a new attribute called <a href=\"https://www.php.net/manual/en/class.sensitiveparameter.php\"><code class=\"language-text\">#[\\SensitiveParameter]</code></a> has been introduced. This attribute proves to be invaluable when dealing with sensitive information in stack traces generated for exceptions. It allows for the redaction of specific parameters, such as passwords, ensuring enhanced security when debugging, or when looking at logs.</p>\n<blockquote>\n<p>Note: Since PHP 7.4 the <code class=\"language-text\">zend.exception_ignore_args = On</code> setting is available for use which allows to include or exclude arguments from stack traces generated for exceptions.</p>\n</blockquote>\n<p>For example, PDO uses the <code class=\"language-text\">$password</code> as a constructor parameter, and immediately tries to connect to the database. When this fails, the stack trace will include the password:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">PDOException: SQLSTATE[HY000] [2002] No such file or directory in /var/www/html/test.php:3\nStack trace:\n#0 /var/www/html/test.php(3): PDO->__construct('mysql:host=loca...', 'root', 'password')\n#1 {main}</code></pre></div>\n<p>When those sensitive parameters are marked by the new attribute, their value will be redacted, meaning instead of <code class=\"language-text\">'password'</code>, we should receive an <strong><code class=\"language-text\">Object(SensitiveParameterValue)</code></strong> in the stack trace.</p>\n<p><em>More information about the attribute can be found in the <a href=\"https://wiki.php.net/rfc/redact_parameters_in_back_traces\">RFC</a>.</em></p>\n<h3 id=\"why-change-from-doctrine-annotations\" style=\"position:relative;\"><a href=\"#why-change-from-doctrine-annotations\" aria-label=\"why change from doctrine annotations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Why Change From Doctrine Annotations?</h3>\n<p>Doctrine Annotations are primarily used by <a href=\"https://github.com/doctrine/orm\">Doctrine ORM</a>, and they already started to migrate to PHP attributes. Consequently, <strong>annotations might face deprecation sooner or later</strong>. Given that Drupal utilizes Doctrine Annotations solely for metadata, and with PHP 8 providing a built-in approach for this purpose (further enhanced by PHP 8.1 readonly properties), Drupal has the option to remove the dependency on Doctrine Annotations for good.</p>\n<h5 id=\"does-this-mean-i-cant-use-annotations-anymore\" style=\"position:relative;\"><a href=\"#does-this-mean-i-cant-use-annotations-anymore\" aria-label=\"does this mean i cant use annotations anymore permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Does this mean I can't use annotations anymore?</h5>\n<p>Drupal 10.2 lets you use attributes to declare custom classes, methods, parameters, properties or constants, but it does not explicitly use them to maintain backwards compatibility. This means contributed and custom modules can start migrating their code, aligning with the evolving standards (something that Drush 11 already did) before Drupal 11.</p>\n<p>This change will lead to:</p>\n<ul>\n<li>Possibly a deprecated <a href=\"https://git.drupalcode.org/project/drupal/-/blob/10.2.x/core/lib/Drupal/Component/Annotation/Plugin/Discovery/AnnotatedClassDiscovery.php\">AnnotatedClassDiscovery</a> removed in Drupal 11.</li>\n<li><strong>A new <a href=\"https://git.drupalcode.org/project/drupal/-/blob/10.2.x/core/lib/Drupal/Component/Plugin/Discovery/AttributeClassDiscovery.php\">AttributeClassDiscovery</a> using Reflection API to find plugins with attributes</strong> (introduced in Drupal 10.2) - There is <a href=\"https://www.drupal.org/project/drupal/issues/3395260\">an active Drupal 11 issue</a> to investigate possibilities on how to improve performance by using something different than the Reflection API.</li>\n</ul>\n<h3 id=\"how-does-the-code-change\" style=\"position:relative;\"><a href=\"#how-does-the-code-change\" aria-label=\"how does the code change permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How does the code change</h3>\n<p>Let's see Drupal Core's <code class=\"language-text\">PageTitleBlock</code> for our example, which <a href=\"https://git.drupalcode.org/project/drupal/-/blob/10.1.x/core/lib/Drupal/Core/Block/Annotation/Block.php\">in Drupal 10.1, uses annotations</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">Drupal<span class=\"token punctuation\">\\</span>Core<span class=\"token punctuation\">\\</span>Block<span class=\"token punctuation\">\\</span>Plugin<span class=\"token punctuation\">\\</span>Block</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token operator\">...</span>\n\n<span class=\"token comment\">/**\n * Provides a block to display the page title.\n *\n * @Block(\n *   id = \"page_title_block\",\n *   admin_label = @Translation(\"Page title\"),\n *   forms = {\n *     \"settings_tray\" = FALSE,\n *   },\n * )\n */</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">PageTitleBlock</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">BlockBase</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">TitleBlockPluginInterface</span> <span class=\"token punctuation\">{</span>\n</span></code></pre></div>\n<p>However, <a href=\"https://git.drupalcode.org/project/drupal/-/blob/10.2.x/core/lib/Drupal/Core/Block/Attribute/Block.php\">in Drupal 10.2 it uses PHP attributes</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">Drupal<span class=\"token punctuation\">\\</span>Core<span class=\"token punctuation\">\\</span>Block<span class=\"token punctuation\">\\</span>Plugin<span class=\"token punctuation\">\\</span>Block</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token operator\">...</span>\n\n<span class=\"token comment\">/**\n * Provides a block to display the page title.\n */</span>\n<span class=\"token attribute\"><span class=\"token delimiter punctuation\">#[</span><span class=\"token attribute-content\"><span class=\"token attribute-class-name class-name\">Block</span><span class=\"token punctuation\">(</span>\n  <span class=\"token attribute-class-name class-name\">id</span><span class=\"token punctuation\">:</span> <span class=\"token string double-quoted-string\">\"page_title_block\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token attribute-class-name class-name\">admin_label</span><span class=\"token punctuation\">:</span> <span class=\"token attribute-class-name class-name\">new</span> <span class=\"token attribute-class-name class-name\">TranslatableMarkup</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"Page title\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token attribute-class-name class-name\">forms</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string single-quoted-string\">'settings_tray'</span> <span class=\"token operator\">=></span> <span class=\"token attribute-class-name class-name\">FALSE</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">)</span></span><span class=\"token delimiter punctuation\">]</span></span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">PageTitleBlock</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">BlockBase</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">TitleBlockPluginInterface</span> <span class=\"token punctuation\">{</span>\n</span></code></pre></div>\n<p>The <a href=\"https://www.drupal.org/node/3395575\">change record</a> says currently all Actions and Blocks are converted to use attributes, but what if I am a contrib/custom module developer and I define custom plugins?</p>\n<p>If we carefully inspect the <code class=\"language-text\">DefaultPluginManager</code> in Drupal 10.2, we notice there is a new constructor parameter called <code class=\"language-text\">$plugin_definition_attribute_name</code> which is initially <code class=\"language-text\">NULL</code>. This means, you'll need to add a new parameter to the parent constructor call (at least until <code class=\"language-text\">$plugin_definition_annotation_name</code> parameter is still in use and not deprecated.)</p>\n<p>If we check the <code class=\"language-text\">BlockManager</code> class, you can see the parent constructor call uses <strong><code class=\"language-text\">Block::class</code></strong> as the <strong>5th parameter</strong> in 10.2</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token comment\">// Before Drupal 10.2</span>\n<span class=\"token keyword static-context\">parent</span><span class=\"token operator\">::</span><span class=\"token function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'Plugin/Block'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$namespaces</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$module_handler</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'Drupal\\Core\\Block\\BlockPluginInterface'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'Drupal\\Core\\Block\\Annotation\\Block'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// After</span>\n<span class=\"token keyword static-context\">parent</span><span class=\"token operator\">::</span><span class=\"token function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'Plugin/Block'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$namespaces</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$module_handler</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'Drupal\\Core\\Block\\BlockPluginInterface'</span><span class=\"token punctuation\">,</span> <span class=\"token class-name static-context\">Block</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'Drupal\\Core\\Block\\Annotation\\Block'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>This parameter is then stored in the <code class=\"language-text\">$pluginDefinitionAttributeName</code> property, and that gets used later in the <code class=\"language-text\">getDiscovery()</code> method of <a href=\"https://git.drupalcode.org/project/drupal/-/blob/10.2.x/core/lib/Drupal/Core/Plugin/DefaultPluginManager.php#L290\">DefaultPluginManager</a>.</p>\n<p>As you can see, this method then decides if it should use:</p>\n<ul>\n<li><a href=\"https://git.drupalcode.org/project/drupal/-/blob/10.2.x/core/lib/Drupal/Core/Plugin/Discovery/AttributeDiscoveryWithAnnotations.php\">AttributeDiscoveryWithAnnotations</a></li>\n<li><a href=\"https://git.drupalcode.org/project/drupal/-/blob/10.2.x/core/lib/Drupal/Core/Plugin/Discovery/AttributeClassDiscovery.php\">AttributeClassDiscovery</a></li>\n<li><a href=\"https://git.drupalcode.org/project/drupal/-/blob/10.2.x/core/lib/Drupal/Core/Plugin/Discovery/AnnotatedClassDiscovery.php\">AnnotatedClassDiscovery</a></li>\n<li>or <a href=\"https://git.drupalcode.org/project/drupal/-/blob/10.2.x/core/lib/Drupal/Core/Plugin/Discovery/ContainerDerivativeDiscoveryDecorator.php\">ContainerDerivativeDiscoveryDecorator</a></li>\n</ul>\n<h3 id=\"thoughts\" style=\"position:relative;\"><a href=\"#thoughts\" aria-label=\"thoughts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Thoughts</h3>\n<p>When creating new plugins from now on, developers should primarily focus on using Attributes in the plugin definitions instead of Doctrine Annotations and ensuring that the appropriate parameters are included in the parent constructor call. The good news is that the process of registering the plugin in the <code class=\"language-text\">services.yml</code> file remains unchanged, allowing the developers to continue using <code class=\"language-text\">parent: default_plugin_manager</code>.</p>\n<p>While the changes may seem subtle, the adoption of PHP attributes opens up new possibilities leading to a more standardized, advanced way of code organization and metadata handling.</p>","frontmatter":{"title":"Attributes In Drupal","date":"December 18, 2023","description":"Drupal 10.2 is out, with an easier content management by improving user experience, and with some performance improvements in caching and HTTP responses. It is also compatible with PHP 8.3, and it started using PHP attributes."},"fields":{"readingTime":{"text":"5 min read"}}},"previous":{"fields":{"slug":"/single-directory-components/"},"frontmatter":{"title":"Single Directory Components"}},"next":null},"pageContext":{"id":"044e3da1-285c-5c99-9689-617c7b7225c8","previousPostId":"a8358ef5-4a34-5c70-9add-1d9d8515a38a","nextPostId":null}},"staticQueryHashes":["2841359383","3204528758","3257411868"],"slicesMap":{}}